<h2 align = "center" >Aula 36  - Arquitetura - 10/11/2022 - Sexta - Feira<h2>

<h3 align = "center" ><a href="https://github.com/ffborelli/curso-brq-java-2022-09-05/">Professor: Fabrizio Borelli</a></h3>


# Revisão


# Objetivo da Aula

1 - Ativar o containner activemq
2 - Trabalhar com filas MQ


## Fila MQ

![](img/36_Broken.png)

Uma fila é um contêiner para mensagens. Os aplicativo de negócios conectados ao gerenciador de filas que hospeda a fila podem recuperar mensagens da fila ou podem gravar mensagens na fila. Uma fila possui uma capacidade limitada em termos do número máximo de mensagens que ela pode manter e o comprimento máximo dessas mensagens.

É um serviço de mensageria,conectando dois sitemas enviando mensagem do sistema A para o sistema B.
É um sistema **assincrono**, ou seja, não existe um encadeamento de eventos, não há dependencias entre quem envia e o retorno.
Usadas para processamento de dados em tempo real, em alto volume de dados.
**Paradigma produtor / consumidor:** onde uma entidade é responsavel por enviar a mensagem e a outra entidade é responsavel por receber a mensagem.
O produtor, envia para um intermediario, e quem recebe a mensagem consulta o intermédiario chamado de **Broker**.
**Consumidores**, são entidades que ficam ouvindo alterações no **Broker**, e quando ocorrer alguma alteração, será capturada e processada.
As mensagem ficam armazenas no **Broker**, até ser consumida por algum consumidor.
Um **Broker**, possui uma estrutura chamada de **tópicos**, que são canais que podemos enviar ou sobrescrever para receber mensagem, ou seja são estruturas que servem para melhor organizar as informações.
Cada **tópicos**, simboliza um padrão ou tipo de mensagem.

## O Papel do Broker

Brokers (Message ou Streams) são utilizados para intermediar a comunicação entre os microsserviços, os quais não possuem contato direto, por meio de roteamento de mensagens. O Message Broker Design Pattern não abrange conceitualmente modelos transacionais, deixando a cargo de Frameworks que implementam determinadas funcionalidades presentes em um Broker a decisão de ser naturalmente transacional ou não lidar com transações de maneira padrão.

## Criar containner MQ

1. Rodar no console com o docker startado:
    - docker run --name activemq -p 61616:61616 -p 8161:8161 rmohr/activemq

## Interface Gráfica

- Acessar **COM** user e senha  [ActiveMQ](http://localhost:8161/)
-  Acessar **SEM** user e senha  [ActiveMQ](http://localhost:8161/admin)
    - Em caso de erro de porta ocupada:
        - Abra o powerShel como adm
        - Rode os comandos:
            - net stop winnat
            - docker rm
            - docker rm activemq
            - docker run --name activemq -p 61616:61616 -p 8161:8161 rmohr/activemq
            
         - Em outra instancia do powerShel como adm rode:
            -  net start winnat  
- Realizar o login:
    - Usuario e senha : admin
![](img/36_ActiveMQ_logar.png)   
    Logado:
![](img/36_ActiveMQ_logado.png)        

## Papel de produtor

- Enviar mensagem para a uma determinada fila.
    - **Lembrando**, a fila MQ está rodando em nosso containner de fila MQ, que possui duas portas ativas? **8161**( padrão da interface gráfica) e **61616**(onde se envia ou se consome a mensagem), que foram informadas no momento em que criamos o nosso containner:
        - **docker run --name activemq -p 61616:61616 -p 8161:8161 rmohr/activemq**
    - Clicar no menu **Send**  

![](img/36_ActiveMQ__EnviarT%C3%B3pico.jpg)   


## Parametrizando para usar a fila MQ

- Adicionar uma nova dependencia ao arquivo: **pom.xml**
- **Lembre-se** de resolver(reload) a nova dependencia no Maven.

```
<dependency>
    <groupId>org.apache.camel.springboot</groupId>
	<artifactId>camel-activemq-starter</artifactId>
	<version>3.5.0</version>
</dependency>

```
<span style="font-family:Cascadia Code; font-size:1.5em;color: #BA55D3">DICA: </span> Notamos que as versões informadas nas dependencias do Camel no arquivo pom.xml, é algo bem repetitivo, assim podemos realizar uma refatoração do arquivo, tornando-o parametrizavel:

- Criar uma propriedade para armazenar a versão do Camel
```diff
<properties>
    <java.version>11</java.version>
+    <camel.version>3.5.8</camel.version>
+    <objectmapper.version>2.3.5</objectmapper.version>
</properties>

```
- Substituir a Version informada em cada dependencia

```diff
 <!-- Apache Camel v3.5 -->
<dependency>
    <groupId>org.apache.camel.springboot</groupId>
    <artifactId>camel-spring-boot-starter</artifactId>
-    <version>3.5.0</version>
+    <version>${camel.version}</version>

</dependency>

<dependency>
    <groupId>org.modelmapper</groupId>
    <artifactId>modelmapper</artifactId>
-    <objectmapper.version>2.3.5</objectmapper.version>
+    <version>${objectmapper.version}</version>
</dependency>

```
- <span style="font-family:Cascadia Code; font-size:1.5em;color: #FF4500">Lembre de resolver as depêndencias do Maven(reload) </span>

## Rota para produzir mensagem para o ActiveMQ


